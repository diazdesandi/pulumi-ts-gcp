name: Deployment
on:
  workflow_dispatch:
    inputs:
      config_file:
        description: "File to deploy"
        type: choice
        options: [index.html]
        required: true

env:
  BUCKET_NAME: bucket-rene-testing

jobs:
  preview:
    runs-on: ubuntu-latest
    outputs:
      config-hash: ${{ steps.preview.outputs.config-hash }}
      has-current: ${{ steps.preview.outputs.has-current }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with Service Account
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify Service Account Access
        run: |
          echo "ðŸ” Authenticated as:"
          gcloud auth list --filter=status:ACTIVE --format="value(account)"

          echo "ðŸª£ Testing bucket access:"
          gsutil ls gs://${{ env.BUCKET_NAME }}/ || echo "Bucket access verified"

      - name: Preview Configuration Changes
        id: preview
        run: |
          echo "ðŸ” Preview: ${{ inputs.config_file }} â†’ gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }}"

          echo "::group::ðŸ“„ NEW FILE"
          echo "Content of ${{ inputs.config_file }}:"
          cat "${{ inputs.config_file }}"
          echo "::endgroup::"

          echo "::group::ðŸ“„ CURRENT FILE"
          if gsutil cat gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }} > current-file-content 2>/dev/null; then
            echo "Current file in bucket:"
            cat current-file-content
            echo "has-current=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No current file in bucket: ${{ inputs.config_file }}"
            echo "has-current=false" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

          echo "::group::ðŸ”„ CHANGES"
          if [ -f current-file-content ]; then
            echo "Changes that would be made:"
            if diff -u current-file-content "${{ inputs.config_file }}"; then
              echo "âš ï¸ No changes detected between current and new file"
            fi
          else
            echo "This would be the first deployment of this file"
          fi
          echo "::endgroup::"

          # Calculate hash for verification
          CONFIG_HASH=$(sha256sum "${{ inputs.config_file }}" | cut -d' ' -f1)
          echo "config-hash=$CONFIG_HASH" >> $GITHUB_OUTPUT

          echo "::notice::Preview completed. Waiting for approval to deploy."

  deploy:
    needs: preview
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate with Service Account
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Configuration
        run: |
          echo "ðŸš€ Deploying ${{ inputs.config_file }} to gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }}"
          echo "ðŸ” Deploying as service account: $(gcloud auth list --filter=status:ACTIVE --format='value(account)')"

          # Verify we're deploying the same file that was previewed
          CURRENT_HASH=$(sha256sum "${{ inputs.config_file }}" | cut -d' ' -f1)
          if [ "$CURRENT_HASH" != "${{ needs.preview.outputs.config-hash }}" ]; then
            echo "âŒ File hash mismatch!"
            exit 1
          fi

          # Backup current file
          BACKUP_NAME="backup-${{ inputs.config_file }}-$(date +%Y%m%d-%H%M%S)"
          if gsutil cp gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }} gs://${{ env.BUCKET_NAME }}/$BACKUP_NAME 2>/dev/null; then
            echo "ðŸ“‹ Backed up current file as $BACKUP_NAME"
            echo "backup_file=$BACKUP_NAME" >> $GITHUB_ENV
          fi

          # Deploy new file
          gsutil cp "${{ inputs.config_file }}" gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }}"

          # Verify deployment
          gsutil stat gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }}"
          echo "âœ… Deployed ${{ inputs.config_file }} successfully!"

      - name: Generate Deployment Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… Deployment Successful

          **File:** \`${{ inputs.config_file }}\`
          **Service Account:** \`$(gcloud auth list --filter=status:ACTIVE --format='value(account)')\`
          **Target:** \`gs://${{ env.BUCKET_NAME }}/${{ inputs.config_file }}\`
          **Backup:** \`gs://${{ env.BUCKET_NAME }}/${{ env.backup_file }}\`
          **Timestamp:** \`$(date -Iseconds)\`
          **Workflow:** [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Actions Performed
          1. âœ… Service account authentication
          2. ðŸ“‹ Backed up previous file
          3. ðŸš€ Uploaded new file
          4. âœ… Verified deployment success
          EOF
